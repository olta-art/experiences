<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Olta Kiosk</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"
    integrity="sha512-CNgIRecGo7nphbeZ04Sc13ka07paqdeTu0WR1IM4kNcpmBAUSHSQX0FslNhTDadL4O5SAGapGt4FodqL8My0mA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="./main.js" type="module"></script>

  <!-- Google tag (gtag.js) -->
  <!-- <script async src="https://www.googletagmanager.com/gtag/js?id=G-C3C3NKFP2L"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-C3C3NKFP2L');
  </script> -->

  <!-- <a class="twitter-timeline" href="https://twitter.com/oltaArt?ref_src=twsrc%5Etfw">Tweets by you</a> -->
  <!-- <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script> -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <meta property="og:title" content="Gesture Control - Interactive Experiences | Olta">
  <meta property="og:description" content="Motion-controlled digital artworks that respond to your movements">
  <meta property="og:type" content="website">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Gesture Control - Interactive Experiences | Olta">
  <meta name="twitter:description" content="Motion-controlled digital artworks that respond to your movements">
</head>

<body>
  <div id="playlist-header" class="playlist-header">
    <div class="playlist-title">Gesture Control - Interactive Experiences</div>
    <div class="playlist-description">Motion-controlled digital artworks that respond to your movements</div>
  </div>
  <div id="playlist-label" class="playlist-label"></div>
  <!-- Navigation feedback indicator -->
  <div id="nav-feedback" class="nav-feedback"></div>

  <!-- Carousel Navigation Buttons - Positioned directly in body like top status bar -->
  <button id="nav-prev-btn" class="carousel-nav-btn carousel-nav-left" aria-label="Previous project">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
  </button>
  <button id="nav-next-btn" class="carousel-nav-btn carousel-nav-right" aria-label="Next project">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    </svg>
  </button>

  <h1 id="loading">LOADING</h1>
  <button class="fullscreen">⛶</button>

  <!-- Hidden navigation buttons for main.js functionality -->
  <button class="change" style="display: none;">Next Project</button>
  <button class="previous" style="display: none;">Previous Project</button>

  <template id="o-details">
    <div class="flex details-panel" part="flex" id="details-panel">
      <p part="qrcode" class="qrcodecanvas">
        <slot name="qrcode"></slot>
      </p>

      <h1 part="name">
        <slot name="name"></slot>
      </h1>
      <h2 part="creator">
        <slot name="creator"></slot>
      </h2>
      <!-- <p part="description">
        <slot name="description"></slot>
      </p> -->
    </div>
    </div>
  </template>
  <dialog class="options">
    <div class="button-container">
      <button class="close">close</button>
    </div>
    <form id="options-form"></form>
  </dialog>
  <div id="top-status-bar">
    <span id="viewer-counter">
      <span class="status-icon" aria-label="Live viewers">
        <!-- Modern user SVG icon -->
        <svg width="18" height="18" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="7" r="4" stroke="#7be7b8" stroke-width="1.5" />
          <ellipse cx="10" cy="15" rx="7" ry="3" stroke="#7be7b8" stroke-width="1.5" />
        </svg>
      </span>
      Live viewers: <span id="viewer-count">0</span>
    </span>
    <span class="status-divider"></span>
    <button id="heart-btn" aria-label="Show appreciation">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path
          d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"
          fill="currentColor" stroke="currentColor" stroke-width="0.5" />
      </svg>
    </button>
    <span id="heart-count">0</span>
    <span class="status-divider"></span>
    <button id="share-btn" aria-label="Share"
      style="background: none; border: none; cursor: pointer; padding: 0 0.1rem; margin-left: 0.3rem; display: flex; align-items: center; gap: 0.3rem;">
      <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M15 8V5a3 3 0 0 0-6 0v3" stroke="#7be7b8" stroke-width="1.5" stroke-linecap="round"
          stroke-linejoin="round" />
        <path d="M10 12v-1" stroke="#7be7b8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
        <path d="M5 8v7a3 3 0 0 0 3 3h4a3 3 0 0 0 3-3V8" stroke="#7be7b8" stroke-width="1.5" stroke-linecap="round"
          stroke-linejoin="round" />
        <path d="M10 12l-2-2m2 2l2-2" stroke="#7be7b8" stroke-width="1.5" stroke-linecap="round"
          stroke-linejoin="round" />
      </svg>
      <span style="color: #ffffff; font-size: 0.9rem; font-weight: 500;">Share</span>
    </button>
  </div>

  <script>
    // Your Firebase config here
    const firebaseConfig = {
      apiKey: "AIzaSyDDEb8UeIk6D0pxl_IWEMADqhLz4ZEsA2g",
      authDomain: "olta-70b79.firebaseapp.com",
      databaseURL: "https://olta-70b79-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "olta-70b79",
      storageBucket: "olta-70b79.appspot.com",
      messagingSenderId: "1009481982599",
      appId: "1:1009481982599:web:c625bd9f64d9625fae8e22"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Generate unique viewer ID
    const viewerId = 'viewer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    console.log('New viewer ID:', viewerId);

    // On page load - add this viewer
    const viewerRef = db.ref('viewers/' + viewerId);
    viewerRef.set({
      timestamp: Date.now(),
      userAgent: navigator.userAgent
    }).then(() => {
      console.log('✅ Viewer added to database:', viewerId);
    }).catch((error) => {
      console.error('❌ Error adding viewer:', error);
    });

    // Remove this viewer when they leave
    viewerRef.onDisconnect().remove().then(() => {
      console.log('✅ Disconnect handler set for viewer:', viewerId);
    });

    // Display count
    db.ref('viewers').on('value', (snapshot) => {
      const count = snapshot.numChildren();
      const viewerCountElement = document.getElementById('viewer-count');
      if (viewerCountElement) {
        viewerCountElement.textContent = count;
        console.log('📊 Live viewers updated:', count);

        // Show all current viewers for debugging
        const viewers = [];
        snapshot.forEach((childSnapshot) => {
          viewers.push(childSnapshot.key);
        });
        console.log('👥 Current viewers:', viewers);
      } else {
        console.error('❌ Viewer count element not found!');
      }
    }, (error) => {
      console.error('❌ Error reading viewer count:', error);
    });

    // Clean up old viewers (older than 5 minutes)
    setInterval(() => {
      const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
      db.ref('viewers').once('value').then((snapshot) => {
        snapshot.forEach((childSnapshot) => {
          const viewer = childSnapshot.val();
          if (viewer && viewer.timestamp < fiveMinutesAgo) {
            childSnapshot.ref.remove();
            console.log('🧹 Cleaned up old viewer:', childSnapshot.key);
          }
        });
      });
    }, 60000); // Check every minute

    // --- HEART REACTION LOGIC ---
    let currentHeartUnsubscribe = null;

    function getCurrentArtworkId() {
      if (window.currentProjectId) return window.currentProjectId;
      return 'static-4'; // fallback
    }

    function listenForHeartCount(artworkId) {
      // Remove previous listener if any
      if (currentHeartUnsubscribe) currentHeartUnsubscribe();
      const heartRef = db.ref('reactions/' + artworkId + '/heart');
      const handler = (snapshot) => {
        const count = snapshot.val() || 0;
        const heartCountElement = document.getElementById('heart-count');
        if (heartCountElement) heartCountElement.textContent = count;
      };
      heartRef.on('value', handler);
      // Provide a way to unsubscribe
      currentHeartUnsubscribe = () => heartRef.off('value', handler);
    }

    document.getElementById('heart-btn').addEventListener('click', () => {
      const artworkId = getCurrentArtworkId();
      const heartRef = db.ref('reactions/' + artworkId + '/heart');
      heartRef.transaction((current) => (current || 0) + 1);
    });

    // Initial listen for first artwork
    listenForHeartCount(getCurrentArtworkId());

    // Listen for artwork changes from main.js
    window.addEventListener('artworkChanged', (e) => {
      const newId = e.detail.id;
      listenForHeartCount(newId);
    });
    // --- END HEART REACTION LOGIC ---

    // Function to get current artwork info for sharing
    function getCurrentArtworkInfo() {
      console.log('=== SHARE DEBUG INFO ===');
      console.log('window.current:', window.current);
      console.log('window.projects:', window.projects);
      console.log('window.options.projects:', window.options?.projects);

      let projectName = '';
      let artistName = '';
      let artworkUrl = '';
      let twitterHandle = '';

      // Method 1: Use currentProject function
      if (window.currentProject && typeof window.currentProject === 'function') {
        const currentProj = window.currentProject();
        console.log('currentProject() result:', currentProj);
        if (currentProj) {
          projectName = currentProj.name || '';
          artistName = currentProj.creator?.profile?.name || '';
          artworkUrl = currentProj.lastAddedVersion?.animation?.url || '';

          // Get Twitter handle for this artwork
          twitterHandle = artworkTwitterHandles[projectName] || '';
        }
      }

      // Method 2: Direct array access
      if (!projectName && window.projects && window.current !== undefined) {
        const proj = window.projects[window.current];
        console.log('Direct array access result:', proj);
        if (proj) {
          projectName = proj.name || '';
          artistName = proj.creator?.profile?.name || '';
          artworkUrl = proj.lastAddedVersion?.animation?.url || '';
          twitterHandle = artworkTwitterHandles[projectName] || '';
        }
      }

      // Method 3: Get from DOM
      if (!projectName) {
        const detailsElement = document.querySelector('o-details');
        if (detailsElement && detailsElement.shadowRoot) {
          const nameSlot = detailsElement.shadowRoot.querySelector('slot[name="name"]');
          const creatorSlot = detailsElement.shadowRoot.querySelector('slot[name="creator"]');
          if (nameSlot) projectName = nameSlot.textContent || '';
          if (creatorSlot) artistName = creatorSlot.textContent || '';
          twitterHandle = artworkTwitterHandles[projectName] || '';
        }
      }

      console.log('Final share info:', { projectName, artistName, artworkUrl, twitterHandle });
      return { projectName, artistName, artworkUrl, twitterHandle };
    }

    // Expose the share function globally
    window.getCurrentArtworkInfo = getCurrentArtworkInfo;

    document.getElementById('share-btn').addEventListener('click', async () => {
      console.log('Share button clicked!');

      // Copy URL to clipboard
      const playlistUrl = window.location.href;
      try {
        await navigator.clipboard.writeText(playlistUrl);
        console.log('Copied to clipboard:', playlistUrl);
      } catch (err) {
        console.warn('Could not copy to clipboard:', err);
      }

      // Get current artwork name from DOM
      const detailsElement = document.querySelector('o-details');
      let projectName = '';
      if (detailsElement && detailsElement.shadowRoot) {
        const nameSlot = detailsElement.shadowRoot.querySelector('slot[name="name"]');
        if (nameSlot) projectName = nameSlot.textContent || '';
      }

      // Twitter handle mapping for gesture control playlist
      const twitterHandles = {
        "Shadows Touch Accross Time": "@epok_tech",
        "Optical Verlet": "@xvijojo",
        "Dissolvi": "@seigneurrrr",
        "Peer into the Flow": "@peerintotheflow"
      };

      const twitterHandle = twitterHandles[projectName] || '';

      // Build tweet text
      let tweetText = `Check out "${projectName}"`;
      if (twitterHandle) {
        tweetText += ` by ${twitterHandle}`;
      }
      tweetText += ` from the Gesture Control - Interactive Experiences playlist on Olta! ${playlistUrl}`;

      console.log('Tweet text:', tweetText);

      // Open Twitter
      const encodedTweetText = encodeURIComponent(tweetText);
      const twitterUrl = `https://twitter.com/intent/tweet?text=${encodedTweetText}`;
      window.open(twitterUrl, '_blank');
    });

    const isMobile = /Mobi|Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

    async function requestCameraOnce() {
      if (!cameraStream && !isMobile) { // Only request on non-mobile
        try {
          cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
          // Use cameraStream for gesture artworks
        } catch (err) {
          console.error('Camera access error:', err);
        }
      }
    }

    if (isMobile) {
      // Show a message: "Gesture control is only available on desktop devices."
    }

    // Carousel navigation buttons - Robust implementation
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM Content Loaded - Looking for navigation elements...');

      let prevBtn = document.getElementById('nav-prev-btn');
      let nextBtn = document.getElementById('nav-next-btn');

      console.log('Navigation elements found:', {
        prevBtn,
        nextBtn
      });

      // Check if navigation functions are available
      console.log('Navigation functions available:', {
        navigatePrevious: typeof window.navigatePrevious,
        navigateNext: typeof window.navigateNext,
        current: window.current,
        options: window.options,
        projects: window.projects
      });

      // Debug: Check if elements are in DOM
      if (prevBtn) {
        console.log('Previous button styles:', window.getComputedStyle(prevBtn));
        console.log('Previous button position:', prevBtn.getBoundingClientRect());
        console.log('Previous button is visible:', prevBtn.offsetParent !== null);
        console.log('Previous button pointer-events:', window.getComputedStyle(prevBtn).pointerEvents);
      } else {
        console.error('Previous button not found in DOM!');
      }

      if (nextBtn) {
        console.log('Next button styles:', window.getComputedStyle(nextBtn));
        console.log('Next button position:', nextBtn.getBoundingClientRect());
        console.log('Next button is visible:', nextBtn.offsetParent !== null);
        console.log('Next button pointer-events:', window.getComputedStyle(nextBtn).pointerEvents);
      } else {
        console.error('Next button not found in DOM!');
      }

      // If buttons don't exist, create them dynamically
      if (!prevBtn || !nextBtn) {
        console.log('Creating navigation buttons dynamically...');

        if (!prevBtn) {
          const newPrevBtn = document.createElement('button');
          newPrevBtn.id = 'nav-prev-btn';
          newPrevBtn.className = 'carousel-nav-btn carousel-nav-left';
          newPrevBtn.setAttribute('aria-label', 'Previous project');
          newPrevBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>';
          document.body.appendChild(newPrevBtn);
          console.log('Created previous button dynamically');
        }

        if (!nextBtn) {
          const newNextBtn = document.createElement('button');
          newNextBtn.id = 'nav-next-btn';
          newNextBtn.className = 'carousel-nav-btn carousel-nav-right';
          newNextBtn.setAttribute('aria-label', 'Next project');
          newNextBtn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>';
          document.body.appendChild(newNextBtn);
          console.log('Created next button dynamically');
        }

        // Re-get the buttons after creating them
        const newPrevBtn = document.getElementById('nav-prev-btn');
        const newNextBtn = document.getElementById('nav-next-btn');
        if (newPrevBtn) prevBtn = newPrevBtn;
        if (newNextBtn) nextBtn = newNextBtn;
      }

      // Function to handle previous navigation
      function handlePreviousNavigation(e) {
        console.log('Previous navigation triggered!');
        e.preventDefault();
        e.stopPropagation();

        // Visual feedback
        showNavigationFeedback('← Previous Artwork', 'left');
        addButtonClickEffect(prevBtn);

        // Method 1: Try to dispatch custom event
        try {
          window.dispatchEvent(new CustomEvent('navigatePrevious'));
          console.log('Custom event dispatched');
        } catch (error) {
          console.error('Error dispatching custom event:', error);
        }

        // Method 2: Try to trigger hidden button
        try {
          const previousBtn = document.querySelector('.previous');
          if (previousBtn && !previousBtn.disabled) {
            console.log('Triggering hidden previous button click');
            previousBtn.click();
          } else {
            console.log('Hidden previous button not found or disabled');
          }
        } catch (error) {
          console.error('Error triggering hidden button:', error);
        }

        // Method 3: Try direct function call
        try {
          if (window.navigatePrevious && typeof window.navigatePrevious === 'function') {
            console.log('Calling navigatePrevious function directly');
            window.navigatePrevious();
          } else {
            console.log('navigatePrevious function not available');
          }
        } catch (error) {
          console.error('Error calling navigatePrevious function:', error);
        }

        // Method 4: Try to access main.js variables directly
        try {
          if (window.current !== undefined && window.options && window.options.projects) {
            console.log('Attempting direct navigation via main.js variables');
            window.current = window.decrementLoop ? window.decrementLoop(window.current, window.options.projects.length) : 0;
            if (window.viewer && window.getUrl) {
              window.viewer.setAttribute("url", window.getUrl());
            }
          }
        } catch (error) {
          console.error('Error with direct navigation:', error);
        }
      }

      // Function to handle next navigation
      function handleNextNavigation(e) {
        console.log('Next navigation triggered!');
        e.preventDefault();
        e.stopPropagation();

        // Visual feedback
        showNavigationFeedback('Next Artwork →', 'right');
        addButtonClickEffect(nextBtn);

        // Method 1: Try to dispatch custom event
        try {
          window.dispatchEvent(new CustomEvent('navigateNext'));
          console.log('Custom event dispatched');
        } catch (error) {
          console.error('Error dispatching custom event:', error);
        }

        // Method 2: Try to trigger hidden button
        try {
          const nextBtn = document.querySelector('.change');
          if (nextBtn && !nextBtn.disabled) {
            console.log('Triggering hidden next button click');
            nextBtn.click();
          } else {
            console.log('Hidden next button not found or disabled');
          }
        } catch (error) {
          console.error('Error triggering hidden button:', error);
        }

        // Method 3: Try direct function call
        try {
          if (window.navigateNext && typeof window.navigateNext === 'function') {
            console.log('Calling navigateNext function directly');
            window.navigateNext();
          } else {
            console.log('navigateNext function not available');
          }
        } catch (error) {
          console.error('Error calling navigateNext function:', error);
        }

        // Method 4: Try to access main.js variables directly
        try {
          if (window.current !== undefined && window.options && window.options.projects) {
            console.log('Attempting direct navigation via main.js variables');
            window.current = window.incrementLoop ? window.incrementLoop(window.current, window.options.projects.length) : 0;
            if (window.viewer && window.getUrl) {
              window.viewer.setAttribute("url", window.getUrl());
            }
          }
        } catch (error) {
          console.error('Error with direct navigation:', error);
        }
      }

      // Function to show navigation feedback
      function showNavigationFeedback(message, direction) {
        const feedback = document.getElementById('nav-feedback');
        if (feedback) {
          feedback.textContent = message;
          feedback.classList.add('show');

          // Remove the show class after animation completes
          setTimeout(() => {
            feedback.classList.remove('show');
          }, 1500);
        }

        // Console feedback
        console.log(`🎨 ${message} - Navigation triggered!`);
      }

      // Function to add button click effect
      function addButtonClickEffect(button) {
        if (button) {
          button.classList.add('clicked');
          setTimeout(() => {
            button.classList.remove('clicked');
          }, 600);
        }
      }

      if (prevBtn) {
        console.log('Adding click listener to previous button...');
        prevBtn.addEventListener('click', (e) => {
          console.log('Previous button clicked! Event:', e);
          handlePreviousNavigation(e);
        });
        // Add hover event listeners for debugging
        prevBtn.addEventListener('mouseenter', () => console.log('Previous button hover start'));
        prevBtn.addEventListener('mouseleave', () => console.log('Previous button hover end'));
        console.log('Previous button event listeners added successfully');
      } else {
        console.error('Previous carousel navigation button not found!');
      }

      if (nextBtn) {
        console.log('Adding click listener to next button...');
        nextBtn.addEventListener('click', (e) => {
          console.log('Next button clicked! Event:', e);
          handleNextNavigation(e);
        });
        // Add hover event listeners for debugging
        nextBtn.addEventListener('mouseenter', () => console.log('Next button hover start'));
        nextBtn.addEventListener('mouseleave', () => console.log('Next button hover end'));
        console.log('Next button event listeners added successfully');
      } else {
        console.error('Next carousel navigation button not found!');
      }

      // Add event listeners to overlays
      // The overlays are removed from the HTML, so this block is no longer needed.
      // if (leftOverlay) {
      //   leftOverlay.addEventListener('click', handlePreviousNavigation);
      //   console.log('Left overlay click listener added');
      // }

      // if (rightOverlay) {
      //   rightOverlay.addEventListener('click', handleNextNavigation);
      //   console.log('Right overlay click listener added');
      // }
    });

    // Update top navigation button states when projects change
    function updateTopNavButtonStates() {
      const topPrevBtn = document.getElementById('nav-prev-btn');
      const topNextBtn = document.getElementById('nav-next-btn');
      const previousBtn = document.querySelector('.previous');
      const nextBtnMain = document.querySelector('.change');

      if (topPrevBtn && previousBtn) {
        topPrevBtn.disabled = previousBtn.disabled;
      }
      if (topNextBtn && nextBtnMain) {
        topNextBtn.disabled = nextBtnMain.disabled;
      }
    }

    // Listen for artwork changes to update button states
    window.addEventListener('artworkChanged', updateTopNavButtonStates);

    // Initial state update
    setTimeout(updateTopNavButtonStates, 2500);
  </script>
</body>

</html>